#!/usr/bin/env python2.7
# -*- coding: utf-8 -*-

if __name__ == "__main__":
    import sys, argparse, axl_sld_translator
    import xml.etree.ElementTree as ET
    import lxml.etree as etree

    try:
        from StringIO import StringIO
    except ImportError:
        from io import StringIO, BytesIO

    ArgP = argparse.ArgumentParser(description="")
    ArgP.add_argument('in_axl', nargs='?', type=argparse.FileType('rb'),
                        default='-') # argparse.FileType interprets "-" as Stdin.
    ArgP.add_argument("-o", "--output", type=argparse.FileType('wb'),
                        default=sys.stdout)
    Args = ArgP.parse_args()

    axl = Args.in_axl.read()
    Args.in_axl.close()

    # Do stuff!
    tree = ET.fromstring(axl)
    root = tree

    for layer_node in root.find("CONFIG").find("MAP").findall("LAYER"):
      if layer_node.attrib["type"] != "featureclass":
        sys.stderr.write("LAYER that isn't a featureclass encountered! Unsupported and ignoring.")
        continue

      layer = axl_sld_translator.Layer("", layer_node)

      Args.output.write(layer.to_sql() + "\n-----\n")

      sld_string = ET.tostring(layer_node, encoding="utf8", method="xml")
      x = etree.fromstring(sld_string)
      #Args.output.write(etree.tostring(x, pretty_print = True))

      #Args.output.write("\n/* INTO */\n\n")
      sld_string = ET.tostring(layer.to_sld(), encoding="utf8", method="xml")
      x = etree.fromstring(sld_string)
      #Args.output.write(etree.tostring(x, pretty_print = True))
      #Args.output.write("\n/* ------------------------------ */\n\n")

    if Args.output != sys.stdout:
      Args.output.close()
